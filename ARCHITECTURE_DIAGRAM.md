# Agent Pattern Test 系统技术架构图

本文档提供系统的完整技术架构视图，包括组件关系、数据流和交互序列。

---

## 1. 整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户/客户端层                                    │
│                    (HTTP Client / Browser / Mobile App)                      │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │ HTTP/REST
                                 ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              控制器层 (Controller)                           │
│  ┌─────────────────────┐              ┌──────────────────────┐             │
│  │  ChatController     │              │ SessionController    │             │
│  │  - POST /api/chat   │              │ - GET /api/sessions  │             │
│  │  - GET /api/welcome │              │ - POST /api/sessions │             │
│  └──────────┬──────────┘              └──────────┬───────────┘             │
└─────────────┼──────────────────────────────────────┼─────────────────────────┘
              │                                      │
              ↓                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                            服务层 (Service)                                  │
│  ┌──────────────────────────────────┐   ┌──────────────────────────────┐   │
│  │   CustomerServiceBot             │   │   SessionManager             │   │
│  │   - 会话管理                      │   │   - 会话CRUD                  │   │
│  │   - Agent调度                    │   │   - 会话分析                  │   │
│  │   - 上下文管理                    │   │   - 自动清理                  │   │
│  └─────────────┬────────────────────┘   └──────────────────────────────┘   │
└────────────────┼────────────────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Agent 层                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Agent 接口                                    │  │
│  │  ┌──────────────┐         ┌──────────────────┐                      │  │
│  │  │ ReactAgent   │         │ ConfigurableAgent│                      │  │
│  │  │ (默认实现)    │         │ (可配置编排器)    │                      │  │
│  │  └──────┬───────┘         └────────┬─────────┘                      │  │
│  └─────────┼──────────────────────────┼────────────────────────────────┘  │
└────────────┼──────────────────────────┼───────────────────────────────────┘
             │                          │
             ↓                          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         编排器层 (Orchestrator)                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    OrchestratorRegistry                             │    │
│  │              (编排器注册表 - ConcurrentHashMap)                      │    │
│  └──────────┬─────────────────────────────────┬────────────────────────┘    │
│             │                                 │                             │
│  ┌──────────▼──────────────┐    ┌────────────▼─────────────────────┐      │
│  │  ReActOrchestrator      │    │  PlanAndExecuteOrchestrator      │      │
│  │  ┌──────────────────┐   │    │  ┌────────────────────────────┐ │      │
│  │  │ 1. 构建提示词     │   │    │  │ Phase 1: Planning          │ │      │
│  │  │ 2. 调用 LLM       │   │    │  │  - 制定完整计划             │ │      │
│  │  │ 3. 解析响应       │   │    │  ├────────────────────────────┤ │      │
│  │  │ 4. 执行工具       │   │    │  │ Phase 2: Execution         │ │      │
│  │  │ 5. 循环迭代       │   │    │  │  - 逐步执行计划             │ │      │
│  │  │ (最多5次)        │   │    │  ├────────────────────────────┤ │      │
│  │  └──────────────────┘   │    │  │ Phase 3: Synthesis         │ │      │
│  │                          │    │  │  - 综合结果生成答案         │ │      │
│  └─────────┬────────────────┘    │  └────────────────────────────┘ │      │
│            │                     └──────────┬─────────────────────────┘      │
└────────────┼────────────────────────────────┼───────────────────────────────┘
             │                                │
             └────────────┬───────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          工具层 (Tools)                                      │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                      ToolRegistry                                   │    │
│  │                (工具注册表 - ConcurrentHashMap)                      │    │
│  └──┬────────┬────────┬────────────────┬────────────────┬──────────────┘    │
│     │        │        │                │                │                   │
│  ┌──▼─────┐ │ ┌──────▼───────┐ ┌──────▼──────┐ ┌──────▼─────────────┐     │
│  │ Order  │ │ │   Product    │ │    FAQ      │ │  Knowledge         │     │
│  │ Query  │ │ │   Search     │ │    Tool     │ │  Search            │     │
│  │ Tool   │ │ │   Tool       │ │             │ │  Tool              │     │
│  └────────┘ │ └──────┬───────┘ └─────────────┘ └──────┬─────────────┘     │
│             │        │                                 │                    │
│             │        ↓                                 ↓                    │
└─────────────┼────────────────────────────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         数据层 (Data Layer)                                  │
│                                                                              │
│  ┌──────────────────────────┐         ┌──────────────────────────────┐     │
│  │  ProductDataLoader       │         │  KnowledgeBaseRegistry       │     │
│  │  ┌────────────────────┐  │         │  ┌────────────────────────┐  │     │
│  │  │ 产品数据管理        │  │         │  │ 知识库管理              │  │     │
│  │  │ - 品牌索引         │  │         │  │ - 多知识库             │  │     │
│  │  │ - 类别索引         │  │         │  │ - 向量检索             │  │     │
│  │  │ - 搜索匹配         │  │         │  │ - 相似度计算           │  │     │
│  │  └────────────────────┘  │         │  └────────────────────────┘  │     │
│  └──────────┬───────────────┘         └──────────┬───────────────────┘     │
│             │                                    │                         │
│  ┌──────────▼───────────────┐         ┌─────────▼──────────────────┐      │
│  │  JSON 配置文件            │         │  知识库加载器               │      │
│  │  ┌────────────────────┐  │         │  ┌──────────────────────┐  │      │
│  │  │apple-products.json │  │         │  │SampleKnowledgeLoader │  │      │
│  │  ├────────────────────┤  │         │  │  - product-manual    │  │      │
│  │  │reolink-products.json│ │         │  │  - tech-support      │  │      │
│  │  └────────────────────┘  │         │  │  - company-policy    │  │      │
│  └──────────────────────────┘         │  ├──────────────────────┤  │      │
│                                        │  │ReolinkKnowledgeLoader│  │      │
│                                        │  │  - product-manual    │  │      │
│                                        │  │  - tech-support      │  │      │
│                                        │  │  - installation      │  │      │
│                                        │  └──────────────────────┘  │      │
│                                        └────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI 模型层 (LLM)                                      │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    ChatModel (Spring AI)                            │    │
│  │  ┌──────────────────────┐         ┌──────────────────────────┐     │    │
│  │  │  OpenAI              │         │  Azure OpenAI            │     │    │
│  │  │  - gpt-4             │   OR    │  - gpt-4                 │     │    │
│  │  │  - gpt-3.5-turbo     │         │  - deployment-name       │     │    │
│  │  └──────────────────────┘         └──────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 多品牌产品架构（核心创新）

```
┌─────────────────────────────────────────────────────────────────┐
│                    ProductSearchTool                             │
│                   (产品搜索工具)                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │ 依赖注入
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                  ProductDataLoader                               │
│                 (产品数据加载器)                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  核心数据结构:                                          │     │
│  │  - Map<String, List<ProductInfo>> productsByBrand     │     │
│  │  - List<ProductInfo> allProducts                      │     │
│  │                                                        │     │
│  │  核心方法:                                              │     │
│  │  - searchProducts(query)      // 全文搜索            │     │
│  │  - getProductsByBrand(brand)  // 按品牌查询          │     │
│  │  - getAllBrands()             // 获取所有品牌        │     │
│  │  - getAllCategories()         // 获取所有类别        │     │
│  └────────────────────────────────────────────────────────┘     │
└────────────────────────┬────────────────────────────────────────┘
                         │ @PostConstruct 自动加载
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│            PathMatchingResourcePatternResolver                   │
│            扫描: classpath:data/products/*.json                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ↓                ↓                ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ apple-       │  │ reolink-     │  │ 其他品牌-     │
│ products.json│  │ products.json│  │ products.json│
└──────────────┘  └──────────────┘  └──────────────┘
        │                │                │
        └────────────────┼────────────────┘
                         ↓
        ┌─────────────────────────────────────┐
        │      ProductInfo 数据模型            │
        │  ┌───────────────────────────────┐  │
        │  │ - id: String                  │  │
        │  │ - name: String                │  │
        │  │ - brand: String               │  │
        │  │ - category: String            │  │
        │  │ - price: String               │  │
        │  │ - description: String         │  │
        │  │ - features: List<String>      │  │
        │  │ - specs: Map<String, String>  │  │
        │  │ - tags: List<String>          │  │
        │  │                               │  │
        │  │ 方法:                          │  │
        │  │ - matches(query): boolean     │  │
        │  │ - toFormattedString(): String │  │
        │  └───────────────────────────────┘  │
        └─────────────────────────────────────┘
```

**扩展新品牌流程**:

```
开发者添加新品牌
    │
    ↓
1. 创建 JSON 文件
   src/main/resources/data/products/newbrand-products.json
    │
    ↓
2. 创建知识库加载器（可选）
   NewBrandKnowledgeLoader.java
    │
    ↓
3. 更新配置
   application.yml → products.supported-brands
    │
    ↓
4. 重启应用
    │
    ↓
ProductDataLoader 自动扫描并加载
    │
    ↓
✅ 新品牌产品可用，无需修改业务代码！
```

---

## 3. 知识库检索架构（RAG）

```
┌─────────────────────────────────────────────────────────────────┐
│                 KnowledgeSearchTool                              │
│                 (知识库搜索工具)                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│              KnowledgeBaseRegistry                               │
│              (知识库注册表)                                       │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  Map<String, KnowledgeBase> knowledgeBases             │     │
│  │                                                        │     │
│  │  已注册知识库:                                          │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │ "product-manual"          (Apple 产品手册)    │     │     │
│  │  │ "tech-support"            (Apple 技术支持)    │     │     │
│  │  │ "company-policy"          (公司政策)         │     │     │
│  │  │ "reolink-product-manual"  (Reolink 产品手册) │     │     │
│  │  │ "reolink-tech-support"    (Reolink 技术支持) │     │     │
│  │  │ "reolink-installation"    (Reolink 安装指南) │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  └────────────────────────────────────────────────────────┘     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│          InMemoryVectorKnowledgeBase                             │
│          (内存向量知识库实现)                                     │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  数据结构:                                              │     │
│  │  - List<Document> documents                           │     │
│  │  - List<List<Double>> documentVectors (TF-IDF)       │     │
│  │  - Map<String, Integer> vocabulary (词汇表)           │     │
│  │                                                        │     │
│  │  检索流程:                                              │     │
│  │  1. 查询向量化 (TF-IDF)                               │     │
│  │  2. 计算相似度 (余弦相似度 + BM25)                     │     │
│  │  3. 综合评分 (0.6 * cosine + 0.4 * bm25)             │     │
│  │  4. 排序并返回 Top-K                                  │     │
│  └────────────────────────────────────────────────────────┘     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                    TextSimilarity                                │
│                  (文本相似度计算工具)                             │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  支持的算法:                                            │     │
│  │  - TF-IDF 向量化                                       │     │
│  │  - 余弦相似度 (Cosine Similarity)                      │     │
│  │  - BM25 相似度                                         │     │
│  │  - Jaccard 相似度                                      │     │
│  │  - 编辑距离 (Levenshtein Distance)                    │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  知识库加载器生命周期                             │
│                                                                  │
│  应用启动                                                         │
│      │                                                           │
│      ↓                                                           │
│  @PostConstruct 触发                                             │
│      │                                                           │
│      ├──→ SampleKnowledgeLoader.loadSampleData()                │
│      │       │                                                   │
│      │       ├──→ loadProductManualKnowledgeBase()              │
│      │       ├──→ loadTechSupportKnowledgeBase()                │
│      │       └──→ loadCompanyPolicyKnowledgeBase()              │
│      │                                                           │
│      └──→ ReolinkKnowledgeLoader.loadReolinkKnowledge()         │
│              │                                                   │
│              ├──→ loadReolinkProductManual()                    │
│              ├──→ loadReolinkTechSupport()                      │
│              └──→ loadReolinkInstallationGuide()                │
│                                                                  │
│  所有知识库加载完成 ✅                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Agent 执行流程（ReAct 模式）

```
用户提问: "Reolink 摄像头连接不上 WiFi 怎么办？"
    │
    ↓
┌─────────────────────────────────────────────────────────────────┐
│  ChatController.chat(request)                                   │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  CustomerServiceBot.chat(request)                               │
│  - 获取/创建 AgentContext                                        │
│  - 调用 reactAgent.execute(context)                             │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  ReactAgent.execute(context)                                    │
│  - 获取 "react" 编排器                                           │
│  - 委托给 ReActOrchestrator                                      │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  ReActOrchestrator.orchestrate(context)                         │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  迭代 1:                                                │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 1. 构建提示词                                     │  │    │
│  │  │    System: "你是客服助手，可用工具: ..."          │  │    │
│  │  │    User: "Reolink 摄像头连接不上 WiFi 怎么办？"   │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 2. 调用 LLM (ChatModel)                          │  │    │
│  │  │    返回:                                          │  │    │
│  │  │    "Thought: 这是技术问题，需要查知识库          │  │    │
│  │  │     Action: knowledge-search                     │  │    │
│  │  │     Action Input: {"query": "Reolink WiFi 连接", │  │    │
│  │  │                    "knowledge_base":             │  │    │
│  │  │                    "reolink-tech-support"}"      │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 3. 解析响应 (正则提取)                           │  │    │
│  │  │    thought = "这是技术问题，需要查知识库"         │  │    │
│  │  │    action = "knowledge-search"                   │  │    │
│  │  │    actionInput = "{...}"                         │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 4. 执行工具                                       │  │    │
│  │  │    ToolRegistry.getTool("knowledge-search")      │  │    │
│  │  │         ↓                                         │  │    │
│  │  │    KnowledgeSearchTool.execute(actionInput)      │  │    │
│  │  │         ↓                                         │  │    │
│  │  │    KnowledgeBaseRegistry.getKnowledgeBase(       │  │    │
│  │  │        "reolink-tech-support"                    │  │    │
│  │  │    )                                              │  │    │
│  │  │         ↓                                         │  │    │
│  │  │    InMemoryVectorKnowledgeBase.search(           │  │    │
│  │  │        "Reolink WiFi 连接", 3                    │  │    │
│  │  │    )                                              │  │    │
│  │  │         ↓                                         │  │    │
│  │  │    [向量检索过程]                                 │  │    │
│  │  │    - TF-IDF 向量化查询                           │  │    │
│  │  │    - 计算文档相似度                              │  │    │
│  │  │    - 排序返回 Top-3 文档                         │  │    │
│  │  │         ↓                                         │  │    │
│  │  │    ToolResult.success(                           │  │    │
│  │  │        "找到相关信息:\n                           │  │    │
│  │  │         【Reolink 摄像头无法连接 WiFi】\n        │  │    │
│  │  │         1. 检查 WiFi 频段...\n                   │  │    │
│  │  │         2. 检查信号强度...\n                     │  │    │
│  │  │         ..."                                     │  │    │
│  │  │    )                                              │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 5. 记录步骤                                       │  │    │
│  │  │    context.addStep(new AgentStep(               │  │    │
│  │  │        thought, action, actionInput, observation │  │    │
│  │  │    ))                                             │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  迭代 2:                                                │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 1. 构建提示词（包含上一步的 observation）         │  │    │
│  │  │    System: "你是客服助手..."                      │  │    │
│  │  │    User: "Reolink 摄像头连接不上 WiFi..."         │  │    │
│  │  │    Scratchpad: "Thought: ...\n                   │  │    │
│  │  │                 Action: knowledge-search\n        │  │    │
│  │  │                 Observation: 找到相关信息...\n"   │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 2. 调用 LLM                                      │  │    │
│  │  │    返回:                                          │  │    │
│  │  │    "Thought: 已获取技术文档，可以回答了          │  │    │
│  │  │     Final Answer: 针对 Reolink 摄像头 WiFi      │  │    │
│  │  │     连接问题，建议按以下步骤排查：                │  │    │
│  │  │     1. 检查 WiFi 频段（2.4G/5G）                 │  │    │
│  │  │     2. 确认信号强度...                           │  │    │
│  │  │     ..."                                         │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │           ↓                                             │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │ 3. 检测到 Final Answer，退出循环                 │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  返回 OrchestratorResult.success(                              │
│      finalAnswer,                                              │
│      steps = [迭代1的步骤, 迭代2的步骤],                        │
│      executionTime,                                            │
│      orchestratorName = "react"                                │
│  )                                                              │
└─────────────────────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  转换为 ChatResponse                                             │
│  {                                                               │
│    "message": "针对 Reolink 摄像头 WiFi 连接问题...",            │
│    "session_id": "xxx",                                         │
│    "success": true,                                             │
│    "execution_time_ms": 2345,                                   │
│    "steps": [                                                   │
│      {                                                          │
│        "thought": "这是技术问题，需要查知识库",                   │
│        "action": "knowledge-search",                            │
│        "action_input": "{...}",                                 │
│        "observation": "找到相关信息..."                          │
│      },                                                         │
│      {                                                          │
│        "thought": "已获取技术文档，可以回答了",                   │
│        "action": null,                                          │
│        "action_input": null,                                    │
│        "observation": null                                      │
│      }                                                          │
│    ]                                                            │
│  }                                                              │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
            返回给用户
```

---

## 5. 会话管理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                   SessionController                              │
│                   (会话管理 REST API)                             │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│                 SessionManager                                   │
│                 (会话管理器接口)                                  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│              DefaultSessionManager                               │
│              (默认会话管理器实现)                                 │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  核心功能:                                              │     │
│  │  - createSession(userId, ttl)                         │     │
│  │  - getSession(sessionId)                              │     │
│  │  - updateSession(session)                             │     │
│  │  - deleteSession(sessionId)                           │     │
│  │  - cleanupExpiredSessions()  (定时任务)               │     │
│  └────────────────────────────────────────────────────────┘     │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│              SessionRepository                                   │
│              (会话存储接口)                                       │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│          InMemorySessionRepository                               │
│          (内存会话存储实现)                                       │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  ConcurrentHashMap<String, Session>                   │     │
│  │                                                        │     │
│  │  Session 数据模型:                                     │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │ - sessionId: String                          │     │     │
│  │  │ - userId: String                             │     │     │
│  │  │ - status: SessionStatus                      │     │     │
│  │  │     (ACTIVE/INACTIVE/EXPIRED/CLOSED)        │     │     │
│  │  │ - messages: List<SessionMessage>            │     │     │
│  │  │ - metadata: Map<String, Object>             │     │     │
│  │  │ - createdAt: LocalDateTime                  │     │     │
│  │  │ - lastAccessedAt: LocalDateTime             │     │     │
│  │  │ - expiresAt: LocalDateTime                  │     │     │
│  │  │                                              │     │     │
│  │  │ SessionMessage:                              │     │     │
│  │  │ - messageId: String                          │     │     │
│  │  │ - role: MessageRole (USER/ASSISTANT)        │     │     │
│  │  │ - content: String                            │     │     │
│  │  │ - timestamp: LocalDateTime                  │     │     │
│  │  │ - executionTimeMs: Long (仅 ASSISTANT)      │     │     │
│  │  │ - toolsUsed: List<String> (仅 ASSISTANT)    │     │     │
│  │  │ - stepCount: Integer (仅 ASSISTANT)         │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│              SessionAnalytics                                    │
│              (会话分析服务)                                       │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  分析功能:                                              │     │
│  │  - getOverallStats()           // 整体统计            │     │
│  │  - getUserBehaviorAnalysis()   // 用户行为分析        │     │
│  │  - getHotTopics()              // 热门话题            │     │
│  │  - getTimeRangeStats()         // 时间范围统计        │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘

定时清理任务:
┌─────────────────────────────────────────────────────────────────┐
│  @Scheduled(cron = "0 0 * * * ?")  // 每小时执行一次             │
│  public void scheduledCleanup() {                               │
│      sessionManager.cleanupExpiredSessions();                   │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 配置与依赖注入

```
application.yml
├─ server.port: 8080
├─ spring.ai.openai
│   ├─ api-key: ${OPENAI_API_KEY}
│   ├─ model: gpt-4
│   └─ chat.options
│       ├─ temperature: 0.7
│       └─ max-tokens: 2000
├─ agent
│   ├─ orchestrator.default: react
│   ├─ react.max-iterations: 5
│   └─ plan-execute.max-steps: 10
├─ knowledge
│   ├─ enabled: true
│   ├─ load-sample-data: true
│   └─ load-reolink-data: true          ⬅️ 新增
├─ products                              ⬅️ 新增
│   ├─ enabled: true
│   ├─ data-path: classpath:data/products/*.json
│   └─ supported-brands
│       ├─ Apple
│       └─ Reolink
├─ chatbot
│   ├─ name: "智能客服助手"
│   └─ context-window: 10
└─ session
    ├─ default-ttl-minutes: 60
    ├─ auto-cleanup: true
    └─ cleanup-cron: "0 0 * * * ?"

Spring Boot 自动装配流程:
┌─────────────────────────────────────────────────────────────────┐
│  应用启动 (AgentPatternApplication.main())                      │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  Spring Context 初始化                                          │
│                                                                 │
│  1. 扫描 @Component/@Service/@Repository                       │
│     - Controllers, Services, Tools, Loaders                    │
│                                                                 │
│  2. 依赖注入                                                     │
│     - 构造器注入                                                 │
│     - 字段注入                                                   │
│                                                                 │
│  3. @PostConstruct 方法执行（按依赖顺序）                        │
│     ├─ ProductDataLoader.loadProducts()                        │
│     │   └─ 加载 apple-products.json + reolink-products.json    │
│     │                                                           │
│     ├─ SampleKnowledgeLoader.loadSampleData()                  │
│     │   └─ 注册 3 个 Apple 知识库                               │
│     │                                                           │
│     ├─ ReolinkKnowledgeLoader.loadReolinkKnowledge()           │
│     │   └─ 注册 3 个 Reolink 知识库                             │
│     │                                                           │
│     ├─ OrderQueryTool.register()                               │
│     ├─ ProductSearchTool.register()                            │
│     ├─ FAQTool.register()                                      │
│     └─ KnowledgeSearchTool.register()                          │
│                                                                 │
│  4. 启动内嵌 Tomcat 服务器                                      │
└─────────────────────────────────────────────────────────────────┘
                 │
                 ↓
         应用就绪，监听 8080 端口
```

---

## 7. 技术栈总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        技术栈全景图                              │
│                                                                 │
│  前端层                                                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ HTTP Client (cURL / Postman / Browser / Mobile App)   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Web 层                                                         │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ Spring Boot 3.2.0                                      │    │
│  │ - Spring Web MVC (REST API)                           │    │
│  │ - Spring Validation (参数校验)                         │    │
│  │ - Jackson (JSON 序列化)                                │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  AI 层                                                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ Spring AI 1.0.0-M3                                     │    │
│  │ - spring-ai-openai-spring-boot-starter                │    │
│  │ - spring-ai-azure-openai-spring-boot-starter          │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  业务层                                                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 自研 Agent 框架                                         │    │
│  │ - Orchestrator 抽象层 (可扩展编排模式)                  │    │
│  │ - Tool Registry (工具注册与调用)                       │    │
│  │ - Knowledge Base (RAG 知识库)                          │    │
│  │ - Session Management (会话管理)                        │    │
│  │ - Product Data Loader (产品数据加载) ⬅️ 新增            │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  数据层                                                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 内存存储                                                │    │
│  │ - ConcurrentHashMap (线程安全)                         │    │
│  │ - JSON 配置文件 (产品数据、知识库数据) ⬅️ 新增          │    │
│  │                                                        │    │
│  │ 未来可扩展:                                             │    │
│  │ - Redis (会话存储)                                      │    │
│  │ - MySQL/PostgreSQL (产品数据)                          │    │
│  │ - Pinecone/Weaviate (向量数据库)                       │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  工具库                                                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ Lombok (简化代码)                                       │    │
│  │ SLF4J + Logback (日志)                                 │    │
│  │ Spring Boot Configuration Processor (配置提示)         │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  LLM 层                                                         │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ OpenAI API                                             │    │
│  │ - GPT-4 / GPT-3.5-turbo                               │    │
│  │                                                        │    │
│  │ Azure OpenAI (可选)                                    │    │
│  │ - 企业级部署                                            │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 部署架构（未来）

```
                        ┌─────────────────┐
                        │   负载均衡器     │
                        │   (Nginx/ALB)   │
                        └────────┬────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
        ┌───────▼──────┐  ┌──────▼─────┐  ┌──────▼─────┐
        │ App Instance │  │ App Instance│  │ App Instance│
        │   (容器化)    │  │   (容器化)  │  │   (容器化)  │
        └───────┬──────┘  └──────┬─────┘  └──────┬─────┘
                │                │                │
                └────────────────┼────────────────┘
                                 │
                    ┌────────────┼────────────┐
                    │            │            │
            ┌───────▼──────┐ ┌──▼────────┐ ┌▼────────────┐
            │    Redis     │ │  MySQL    │ │  Vector DB  │
            │  (会话缓存)   │ │ (产品数据) │ │ (知识库)    │
            └──────────────┘ └───────────┘ └─────────────┘

监控体系:
  - Prometheus (指标采集)
  - Grafana (可视化)
  - ELK Stack (日志分析)
  - Jaeger (分布式追踪)
```

---

## 总结

### 核心架构特点

1. **分层清晰**: Controller → Service → Agent → Orchestrator → Tools → Data
2. **高度解耦**: 基于接口编程，依赖注入
3. **易于扩展**:
   - 新增编排器：实现 `Orchestrator` 接口
   - 新增工具：实现 `Tool` 接口
   - 新增品牌：添加 JSON 配置文件（无需改代码）⬅️ **核心创新**
   - 新增知识库：实现 `KnowledgeBase` 接口
4. **性能优化**:
   - 内存缓存
   - 并发安全（ConcurrentHashMap）
   - 向量检索优化
5. **可观测性**:
   - 详细日志
   - 执行步骤追踪
   - 会话分析统计

### Reolink 集成亮点

✅ **零侵入**: 未修改任何现有业务代码
✅ **模块化**: 产品数据、知识库、工具完全独立
✅ **可配置**: 通过配置文件控制启用/禁用
✅ **可测试**: 提供完整的测试脚本

这套架构可以轻松支持**任意数量的品牌**扩展！
